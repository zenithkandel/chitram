<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gallery - ‡§ö‡§ø‡§§‡•ç‡§∞‡§Æ‡•ç Art Platform</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <a href="/">‡§ö‡§ø‡§§‡•ç‡§∞‡§Æ‡•ç</a>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="/" class="nav-link">Home</a>
                </li>
                <li class="nav-item">
                    <a href="/about" class="nav-link">About</a>
                </li>
                <li class="nav-item">
                    <a href="/apply" class="nav-link">Apply</a>
                </li>
                <li class="nav-item">
                    <a href="/artists" class="nav-link">Artists</a>
                </li>
                <li class="nav-item">
                    <a href="/gallery" class="nav-link active">Gallery</a>
                </li>
                <li class="nav-item">
                    <a href="/cart" class="nav-link">
                        <i class="fas fa-shopping-cart"></i> Cart
                        <span id="cart-count" class="cart-count" style="display: none;">0</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/track-orders" class="nav-link">Track Orders</a>
                </li>
            </ul>
            <div class="nav-toggle" id="mobile-menu">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <h1>Art Gallery</h1>
            <p>Explore our beautiful collection of artworks from talented artists.</p>

            <!-- Search and Filter Section -->
            <div class="gallery-controls">
                <!-- Search Bar -->
                <div class="search-container">
                    <div class="search-bar">
                        <input type="text" 
                               id="searchInput" 
                               placeholder="Search artworks, artists, or categories..." 
                               autocomplete="off">
                        <button type="button" id="searchBtn" class="search-button">
                            <span id="searchIcon">üîç</span>
                            <span id="searchSpinner" class="loading-spinner" style="display: none;"></span>
                        </button>
                    </div>
                </div>

                <!-- Filter Section -->
                <div class="filter-container">
                    <div class="filter-group">
                        <label for="sortBy">Sort by:</label>
                        <select id="sortBy" class="filter-select">
                            <option value="date_newest">Date: Newest First</option>
                            <option value="date_oldest">Date: Oldest First</option>
                            <option value="price_low_high">Price: Low to High</option>
                            <option value="price_high_low">Price: High to Low</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="categoryFilter">Category:</label>
                        <select id="categoryFilter" class="filter-select">
                            <option value="all">All Categories</option>
                            <!-- Categories will be loaded dynamically -->
                        </select>
                    </div>

                    <button type="button" id="resetBtn" class="reset-button">Reset Filters</button>
                </div>
            </div>

            <% if (error) { %>
                <div class="error-message" id="errorMessage">
                    <p><%= error %></p>
                </div>
            <% } %>

            <!-- Artworks Grid -->
            <div id="artworksContainer">
                <% if (artworks && artworks.length > 0) { %>
                    <div class="gallery-grid" id="galleryGrid">
                        <% artworks.forEach(function(artwork) { %>
                            <div class="artwork-card">
                                <a href="/artwork/<%= artwork.unique_id %>" class="artwork-link">
                                    <div class="artwork-image">
                                        <% if (artwork.art_image) { %>
                                            <img src="/uploads/artworks/<%= artwork.art_image %>" 
                                                 alt="<%= artwork.art_name %>" 
                                                 onerror="handleImageError(this)">
                                        <% } else { %>
                                            <div class="placeholder-image">
                                                <span>No Image</span>
                                            </div>
                                        <% } %>
                                        <div class="artwork-status <%= artwork.status %>">
                                            <%= artwork.status.charAt(0).toUpperCase() + artwork.status.slice(1) %>
                                        </div>
                                    </div>
                                    <div class="artwork-info">
                                        <h3 class="artwork-name"><%= artwork.art_name %></h3>
                                        <p class="artist-name">by <%= artwork.artist_name || 'Unknown Artist' %></p>
                                        <p class="artwork-category"><%= artwork.art_category %></p>
                                        <% if (artwork.art_description && artwork.art_description.length > 100) { %>
                                            <p class="artwork-description"><%= artwork.art_description.substring(0, 100) %>...</p>
                                        <% } else if (artwork.art_description) { %>
                                            <p class="artwork-description"><%= artwork.art_description %></p>
                                        <% } %>
                                        
                                        <div class="artwork-details">
                                            <div class="detail-item">
                                                <span class="label">Size:</span>
                                                <span class="value"><%= artwork.size_of_art || 'Not specified' %></span>
                                            </div>
                                            <div class="detail-item">
                                                <span class="label">Type:</span>
                                                <span class="value">
                                                    <%= artwork.color_type === 'black_and_white' ? 'Black & White' : 'Color' %>
                                                </span>
                                            </div>
                                            <div class="detail-item">
                                                <span class="label">Work Hours:</span>
                                                <span class="value"><%= artwork.work_hours || 'Not specified' %></span>
                                            </div>
                                        </div>
                                        
                                        <div class="artwork-footer">
                                            <span class="artwork-price">‚Çπ<%= parseFloat(artwork.cost).toLocaleString() %></span>
                                            <% if (artwork.status === 'listed') { %>
                                                <button class="add-to-cart-btn" 
                                                        onclick="addToCartFromData(this)"
                                                        data-artwork-id="<%= artwork.unique_id %>"
                                                        data-artwork-name="<%= artwork.art_name.replace(/"/g, '&quot;') %>"
                                                        data-artwork-cost="<%= artwork.cost %>"
                                                        data-artwork-image="<%= artwork.art_image %>"
                                                        data-artist-name="<%= artwork.artist_name.replace(/"/g, '&quot;') %>"
                                                        data-artist-id="<%= artwork.artist_unique_id %>">
                                                    <i class="fas fa-shopping-cart"></i>
                                                    Add to Cart
                                                </button>
                                            <% } %>
                                        </div>
                                    </div>
                                </a>
                            </div>
                        <% }); %>
                    </div>
                <% } else { %>
                    <div class="no-artworks" id="noArtworks">
                        <p>No artworks available at the moment.</p>
                    </div>
                <% } %>
            </div>
        </div>
    </main>

    <script src="/js/cart.js"></script>
    <script src="/js/main.js"></script>
    <script>
        let searchTimeout;
        
        function handleImageError(img) {
            // Prevent infinite loading attempts
            if (img.dataset.failed) return;
            img.dataset.failed = 'true';
            
            // Replace with placeholder
            const placeholder = document.createElement('div');
            placeholder.className = 'placeholder-image';
            placeholder.innerHTML = '<span>No Image</span>';
            img.parentNode.replaceChild(placeholder, img);
        }

        // Add to cart functionality for gallery cards
        function addToCartFromData(button) {
            // Extract data from button attributes
            const artworkData = {
                unique_id: button.getAttribute('data-artwork-id'),
                art_name: button.getAttribute('data-artwork-name'),
                cost: parseFloat(button.getAttribute('data-artwork-cost')),
                art_image: button.getAttribute('data-artwork-image'),
                artist_name: button.getAttribute('data-artist-name'),
                artist_unique_id: button.getAttribute('data-artist-id')
            };
            
            cartManager.addToCart(artworkData);
        }
        
        // Load categories for filter dropdown
        async function loadCategories() {
            try {
                const response = await fetch('/api/gallery/categories');
                const data = await response.json();
                
                if (data.categories) {
                    const categorySelect = document.getElementById('categoryFilter');
                    
                    // Clear existing options except "All Categories"
                    categorySelect.innerHTML = '<option value="all">All Categories</option>';
                    
                    // Add category options
                    data.categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        categorySelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }
        
        // Search and filter artworks
        async function searchAndFilterArtworks() {
            const searchInput = document.getElementById('searchInput');
            const sortBy = document.getElementById('sortBy');
            const categoryFilter = document.getElementById('categoryFilter');
            const searchBtn = document.getElementById('searchBtn');
            const searchIcon = document.getElementById('searchIcon');
            const searchSpinner = document.getElementById('searchSpinner');
            const artworksContainer = document.getElementById('artworksContainer');
            const errorMessage = document.getElementById('errorMessage');
            
            // Show loading state
            searchIcon.style.display = 'none';
            searchSpinner.style.display = 'inline-block';
            searchBtn.disabled = true;
            
            // Hide error message
            if (errorMessage) {
                errorMessage.style.display = 'none';
            }
            
            try {
                const params = new URLSearchParams({
                    q: searchInput.value || '',
                    sortBy: sortBy.value || 'date_newest',
                    category: categoryFilter.value || 'all'
                });
                
                const response = await fetch(`/api/gallery/search?${params}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Update artworks display
                updateArtworksDisplay(data.artworks);
                
            } catch (error) {
                console.error('Search error:', error);
                artworksContainer.innerHTML = `
                    <div class="error-message">
                        <p>Error searching artworks. Please try again.</p>
                    </div>
                `;
            } finally {
                // Reset button state
                searchIcon.style.display = 'inline-block';
                searchSpinner.style.display = 'none';
                searchBtn.disabled = false;
            }
        }
        
        function updateArtworksDisplay(artworks) {
            const artworksContainer = document.getElementById('artworksContainer');
            
            if (artworks.length === 0) {
                artworksContainer.innerHTML = `
                    <div class="no-artworks">
                        <p>No artworks found matching your criteria.</p>
                    </div>
                `;
                return;
            }
            
            let artworksHTML = '<div class="gallery-grid" id="galleryGrid">';
            
            artworks.forEach(artwork => {
                const imageHTML = artwork.art_image 
                    ? `<img src="/uploads/artworks/${artwork.art_image}" 
                           alt="${artwork.art_name}" 
                           onerror="handleImageError(this)">`
                    : `<div class="placeholder-image"><span>No Image</span></div>`;
                
                const price = parseFloat(artwork.cost).toLocaleString();
                
                // Status badge
                let statusBadge = '';
                if (artwork.status === 'sold') {
                    statusBadge = '<span class="status-badge sold">Sold</span>';
                } else if (artwork.status === 'reserved') {
                    statusBadge = '<span class="status-badge reserved">Reserved</span>';
                } else {
                    statusBadge = '<span class="status-badge available">Available</span>';
                }
                
                // Truncate description for card view
                const description = artwork.art_description ? 
                    (artwork.art_description.length > 100 ? 
                        artwork.art_description.substring(0, 100) + '...' : 
                        artwork.art_description) : 'No description available';
                
                artworksHTML += `
                    <div class="artwork-card">
                        ${statusBadge}
                        <a href="/artwork/${artwork.unique_id}" class="artwork-link">
                            <div class="artwork-image">
                                ${imageHTML}
                            </div>
                            <div class="artwork-info">
                                <h3 class="artwork-name">${artwork.art_name}</h3>
                                <p class="artist-name">by ${artwork.artist_name || 'Unknown Artist'}</p>
                                <p class="artwork-description">${description}</p>
                                <div class="artwork-details">
                                    <div class="detail-row">
                                        <span class="detail-label">Category:</span>
                                        <span class="detail-value">${artwork.art_category}</span>
                                    </div>
                                    ${artwork.size_of_art ? `
                                    <div class="detail-row">
                                        <span class="detail-label">Size:</span>
                                        <span class="detail-value">${artwork.size_of_art}</span>
                                    </div>
                                    ` : ''}
                                    ${artwork.color_type ? `
                                    <div class="detail-row">
                                        <span class="detail-label">Type:</span>
                                        <span class="detail-value">${artwork.color_type}</span>
                                    </div>
                                    ` : ''}
                                    ${artwork.work_hours ? `
                                    <div class="detail-row">
                                        <span class="detail-label">Work Hours:</span>
                                        <span class="detail-value">${artwork.work_hours}</span>
                                    </div>
                                    ` : ''}
                                </div>
                                <p class="artwork-price">‚Çπ${price}</p>
                            </div>
                        </a>
                        <div class="artwork-actions">
                            ${artwork.status === 'available' ? `
                                <button class="btn-cart" onclick="addToCartFromData(event, '${artwork.unique_id}', '${artwork.art_name}', '${artwork.cost}', '${artwork.art_image}', '${artwork.artist_name}')">
                                    Add to Cart
                                </button>
                            ` : `
                                <button class="btn-cart disabled" disabled>
                                    ${artwork.status === 'sold' ? 'Sold Out' : 'Reserved'}
                                </button>
                            `}
                        </div>
                    </div>
                `;
            });
            
            artworksHTML += '</div>';
            artworksContainer.innerHTML = artworksHTML;
        }
        
        // Reset all filters
        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('sortBy').value = 'date_newest';
            document.getElementById('categoryFilter').value = 'all';
            searchAndFilterArtworks();
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            const searchBtn = document.getElementById('searchBtn');
            const sortBy = document.getElementById('sortBy');
            const categoryFilter = document.getElementById('categoryFilter');
            const resetBtn = document.getElementById('resetBtn');
            
            // Load categories on page load
            loadCategories();
            
            // Search on keydown with debounce
            searchInput.addEventListener('keydown', function(e) {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    searchAndFilterArtworks();
                }, 500); // 500ms delay for typing
            });
            
            // Search on button click
            searchBtn.addEventListener('click', function() {
                clearTimeout(searchTimeout);
                searchAndFilterArtworks();
            });
            
            // Search on Enter key
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    clearTimeout(searchTimeout);
                    searchAndFilterArtworks();
                }
            });
            
            // Filter on dropdown change
            sortBy.addEventListener('change', searchAndFilterArtworks);
            categoryFilter.addEventListener('change', searchAndFilterArtworks);
            
            // Reset button
            resetBtn.addEventListener('click', resetFilters);
        });
    </script>
</body>
</html>
